@page "/parent"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Services
@using JunoBank.Web.Utils
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Parent Dashboard</PageTitle>

<div class="page-container-xl">

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else
    {
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <MudText Typo="Typo.h3" HtmlTag="h1">
                Welcome, @_userName!
            </MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                           Color="Color.Default"
                           Size="Size.Large"
                           aria-label="Settings"
                           OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.Settings))" />
        </div>

        <!-- Children Cards -->
        <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">Your Children</MudText>
        <div class="children-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            @foreach (var child in _children)
            {
                <ChildCard Child="child" OnClick="HandleChildClick" />
            }
        </div>

        @if (_children.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                No children found. Set up your first child in Settings!
            </MudAlert>
        }

        <!-- Overall Pending Requests -->
        @if (_totalPendingRequests > 0)
        {
            <div class="neu-card" style="padding: 2rem; text-align: center; cursor: pointer;"
                 @onclick="@(() => Navigation.NavigateTo("/parent/requests"))">
                <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 0.5rem;">
                    Total Pending Requests
                </MudText>
                <MudText Typo="Typo.h2" Style="color: #FFA726; font-weight: bold;">
                    @_totalPendingRequests
                </MudText>
                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); margin-top: 0.5rem;">
                    Tap to review all
                </MudText>
            </div>
        }
    }
</div>

@code {
    private bool _isLoading = true;
    private string _userName = string.Empty;
    private List<ChildSummary> _children = new();
    private int _totalPendingRequests;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session != null)
        {
            _userName = session.UserName;
            _children = await UserService.GetAllChildrenSummaryAsync();
            _totalPendingRequests = _children.Sum(c => c.PendingRequestCount);
        }

        _isLoading = false;
    }

    private void HandleChildClick(ChildSummary child)
    {
        Navigation.NavigateTo(AppRoutes.Parent.ChildDetail(child.Id));
    }
}
