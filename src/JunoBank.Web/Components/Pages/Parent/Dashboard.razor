@page "/parent"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Services
@using JunoBank.Web.Utils
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Parent Dashboard</PageTitle>

<div style="max-width: 800px; margin: 0 auto; padding: 2rem;">

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else
    {
        <MudText Typo="Typo.h3" Style="margin-bottom: 2rem;">
            Welcome, @_userName!
        </MudText>

        <!-- Children Cards -->
        <MudText Typo="Typo.h5" Style="margin-bottom: 1rem;">Your Children</MudText>
        <div class="children-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            @foreach (var child in _children)
            {
                <ChildCard Child="child" OnClick="HandleChildClick" />
            }
        </div>

        @if (_children.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                No children found. Set up your first child in Settings!
            </MudAlert>
        }

        <!-- Overall Pending Requests -->
        @if (_totalPendingRequests > 0)
        {
            <div class="neu-card" style="padding: 2rem; text-align: center; margin-bottom: 2rem; cursor: pointer;"
                 @onclick="@(() => Navigation.NavigateTo("/parent/requests"))">
                <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 0.5rem;">
                    Total Pending Requests
                </MudText>
                <MudText Typo="Typo.h2" Style="color: #FFA726; font-weight: bold;">
                    @_totalPendingRequests
                </MudText>
                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); margin-top: 0.5rem;">
                    Tap to review all
                </MudText>
            </div>
        }

        <!-- Quick Actions -->
        <MudText Typo="Typo.h5" Style="margin-bottom: 1rem;">Quick Actions</MudText>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/requests"))">
                üìã Review Requests
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/history"))">
                üìú Transaction History
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/settings"))">
                ‚öôÔ∏è Settings
            </MudButton>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private string _userName = string.Empty;
    private List<ChildSummary> _children = new();
    private int _totalPendingRequests;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session != null)
        {
            _userName = session.UserName;
            _children = await UserService.GetAllChildrenSummaryAsync();
            _totalPendingRequests = _children.Sum(c => c.PendingRequestCount);
        }

        _isLoading = false;
    }

    private void HandleChildClick(ChildSummary child)
    {
        Navigation.NavigateTo(AppRoutes.Parent.ChildDetail(child.Id));
    }
}
