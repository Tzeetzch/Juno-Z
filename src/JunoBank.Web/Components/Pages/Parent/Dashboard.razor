@page "/parent"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Services
@inject CustomAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Parent Dashboard</PageTitle>

<div style="max-width: 800px; margin: 0 auto; padding: 2rem;">

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else
    {
        <MudText Typo="Typo.h3" Style="margin-bottom: 2rem;">
            Welcome, @_userName!
        </MudText>

        <!-- Child Balance Card -->
        <div class="neu-card" style="padding: 2rem; text-align: center; margin-bottom: 2rem;">
            <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 0.5rem;">
                @_data.ChildName's Balance
            </MudText>
            <MudText Typo="Typo.h2" Style="color: var(--mud-palette-primary); font-weight: bold;">
                ‚Ç¨@_data.ChildBalance.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
            </MudText>
        </div>

        <!-- Pending Requests Card -->
        <div class="neu-card" style="padding: 2rem; text-align: center; margin-bottom: 2rem; cursor: pointer;"
             @onclick="@(() => Navigation.NavigateTo("/parent/requests"))">
            <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 0.5rem;">
                Pending Requests
            </MudText>
            <MudText Typo="Typo.h2" Style="@($"color: {(_data.PendingRequestCount > 0 ? "#FFA726" : "#4caf50")}; font-weight: bold;")">
                @_data.PendingRequestCount
            </MudText>
            @if (_data.PendingRequestCount > 0)
            {
                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); margin-top: 0.5rem;">
                    Tap to review
                </MudText>
            }
        </div>

        <!-- Quick Actions -->
        <MudText Typo="Typo.h5" Style="margin-bottom: 1rem;">Quick Actions</MudText>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/requests"))">
                üìã Review Requests
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/transaction"))">
                üí∞ Add/Remove Money
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/history"))">
                üìú Transaction History
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo("/parent/settings"))">
                ‚öôÔ∏è Settings
            </MudButton>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private string _userName = string.Empty;
    private ParentDashboardData _data = new();

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session != null)
        {
            _userName = session.UserName;
            _data = await UserService.GetParentDashboardDataAsync();
        }

        _isLoading = false;
    }
}
