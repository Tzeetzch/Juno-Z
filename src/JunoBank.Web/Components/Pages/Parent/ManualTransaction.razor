@page "/parent/transaction"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Data.Entities
@using JunoBank.Web.Services
@inject CustomAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Add/Remove Money</PageTitle>

<div class="page-container-sm">

    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => Navigation.NavigateTo("/parent"))">
        ‚Üê Back to Dashboard
    </MudButton>

    <MudText Typo="Typo.h4" HtmlTag="h1" Style="margin: 1rem 0 2rem;">
        üí∞ Add or Remove Money
    </MudText>

    <ErrorAlert Message="@_errorMessage" OnClose="@(() => _errorMessage = string.Empty)" />

    <div class="neu-card" style="padding: 2rem;">
        <EditForm Model="_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <MudRadioGroup @bind-Value="_model.Type" Class="mb-4">
                <MudRadio Value="TransactionType.Deposit" Color="Color.Success">
                    Add Money (Deposit)
                </MudRadio>
                <MudRadio Value="TransactionType.Withdrawal" Color="Color.Error">
                    Remove Money (Withdrawal)
                </MudRadio>
            </MudRadioGroup>

            <MoneyInput @bind-Value="_model.Amount"
                        Required="true"
                        HelperText="Max ‚Ç¨1000" />

            <DescriptionField @bind-Value="_model.Description"
                              HelperText="What is this for?"
                              Placeholder="Chores, birthday money, etc." />

            <SubmitButton LoadingText="Processing..."
                          IsLoading="_isSubmitting"
                          Class="mt-6" />
        </EditForm>
    </div>
</div>

@code {
    private ManualTransactionModel _model = new();
    private bool _isSubmitting = false;
    private string _errorMessage = string.Empty;
    private int _parentUserId;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session == null || session.Role != UserRole.Parent)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _parentUserId = session.UserId;
    }

    private async Task HandleSubmit()
    {
        if (_parentUserId == 0)
        {
            _errorMessage = "Invalid session. Please log in again.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = string.Empty;

        try
        {
            await UserService.CreateManualTransactionAsync(
                _parentUserId,
                _model.Amount,
                _model.Type,
                _model.Description
            );

            var action = _model.Type == TransactionType.Deposit ? "added" : "removed";
            Snackbar.Add($"‚Ç¨{_model.Amount:0.00} {action} successfully!", Severity.Success);

            // Reset form
            _model = new ManualTransactionModel();
        }
        catch (InvalidOperationException ex)
        {
            _errorMessage = ex.Message;
        }
        catch (ArgumentException ex)
        {
            _errorMessage = ex.Message;
        }
        catch (Exception)
        {
            _errorMessage = "Something went wrong. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    public class ManualTransactionModel
    {
        public TransactionType Type { get; set; } = TransactionType.Deposit;
        public decimal Amount { get; set; } = 0.00m;
        public string Description { get; set; } = string.Empty;
    }
}
