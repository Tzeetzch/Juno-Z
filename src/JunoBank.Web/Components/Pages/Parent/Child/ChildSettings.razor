@page "/parent/child/{ChildId:int}/settings"
@attribute [Authorize(Roles = "Parent")]
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject IAllowanceService AllowanceService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IBrowserTimeService BrowserTime

<PageTitle>Settings - @(_child?.Name ?? "Child")</PageTitle>

<div class="page-container">
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else if (_child == null)
    {
        <MudAlert Severity="Severity.Error">Child not found</MudAlert>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   Class="mt-4"
                   OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.Dashboard))">
            Back to Dashboard
        </MudButton>
    }
    else
    {
        <ChildContextHeader ChildName="@_child.Name" BackUrl="@AppRoutes.Parent.ChildDetail(ChildId)" />

        <MudText Typo="Typo.h4" HtmlTag="h1" Style="margin-bottom: 2rem;">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" /> Settings for @_child.Name
        </MudText>

        <!-- Standing Orders Section -->
        <div class="neu-card" style="padding: 2rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <MudText Typo="Typo.h5" HtmlTag="h2">
                    ðŸ’° Standing Orders
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@AddNewOrder">
                    Add
                </MudButton>
            </div>

            @if (_orders.Count == 0)
            {
                <MudAlert Severity="Severity.Info">
                    No standing orders yet. Add one to schedule automatic payments!
                </MudAlert>
            }
            else
            {
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    @foreach (var order in _orders)
                    {
                        <div style="border-radius: 8px; padding: 1rem; background: var(--mud-palette-background-grey);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                            â‚¬@order.Amount.ToString("0.00")
                                        </MudText>
                                        @if (!order.IsActive)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Default">Paused</MudChip>
                                        }
                                    </div>
                                    <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">
                                        @order.Description
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                        @FormatSchedule(order)
                                    </MudText>
                                    @if (order.IsActive)
                                    {
                                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-primary);">
                                            Next: @FormatNextRun(order.NextRunDate)
                                        </MudText>
                                    }
                                </div>
                                <div style="display: flex; gap: 0.25rem;">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   OnClick="@(() => EditOrder(order))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="@(() => DeleteOrder(order))" />
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Picture Password Section -->
        <div class="neu-card" style="padding: 2rem;">
            <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Class="mr-2" /> Picture Password
            </MudText>

            @if (_lockoutStatus is { IsLocked: true })
            {
                <MudAlert Severity="Severity.Warning" Class="mb-3">
                    @_child.Name's account is locked until @BrowserTime.ToLocal(_lockoutStatus.LockedUntil!.Value).ToString("h:mm tt").
                    <MudButton Variant="Variant.Text"
                               Color="Color.Warning"
                               Size="Size.Small"
                               OnClick="UnlockChild"
                               Class="ml-2">
                        Unlock Now
                    </MudButton>
                </MudAlert>
            }
            else if (_lockoutStatus is { FailedAttempts: > 0 })
            {
                <MudAlert Severity="Severity.Info" Class="mb-3" Dense="true">
                    @_lockoutStatus.FailedAttempts failed login attempt(s).
                </MudAlert>
            }

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="OpenResetDialog">
                Reset Password
            </MudButton>
        </div>
    }
</div>

@code {
    [Parameter] public int ChildId { get; set; }

    private User? _child;
    private List<ScheduledAllowance> _orders = new();
    private ChildLockoutStatus? _lockoutStatus;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session == null || session.Role != UserRole.Parent)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _child = await UserService.GetChildByIdAsync(ChildId);
        
        if (_child != null)
        {
            await LoadOrders();
            _lockoutStatus = await UserService.GetChildLockoutStatusAsync(ChildId);
        }

        _isLoading = false;
    }

    private async Task LoadOrders()
    {
        _orders = await AllowanceService.GetOrdersForChildAsync(ChildId);
    }

    private string FormatSchedule(ScheduledAllowance order)
    {
        return order.Interval switch
        {
            AllowanceInterval.Hourly => "Every hour",
            AllowanceInterval.Daily => $"Daily at {order.TimeOfDay:h:mm tt}",
            AllowanceInterval.Weekly => $"Every {order.DayOfWeek} at {order.TimeOfDay:h:mm tt}",
            AllowanceInterval.Monthly => $"Monthly on day {order.DayOfMonth} at {order.TimeOfDay:h:mm tt}",
            AllowanceInterval.Yearly => $"Yearly on {GetMonthName(order.MonthOfYear)} {order.DayOfMonth}",
            _ => "Unknown"
        };
    }

    private static string GetMonthName(int month) => month switch
    {
        1 => "Jan", 2 => "Feb", 3 => "Mar", 4 => "Apr", 5 => "May", 6 => "Jun",
        7 => "Jul", 8 => "Aug", 9 => "Sep", 10 => "Oct", 11 => "Nov", 12 => "Dec",
        _ => "?"
    };

    private string FormatNextRun(DateTime nextUtc)
    {
        var local = BrowserTime.ToLocal(nextUtc);
        var now = BrowserTime.ToLocal(DateTime.UtcNow);
        var diff = local - now;

        if (diff.TotalDays < 1)
            return local.ToString("'Today at' h:mm tt");
        if (diff.TotalDays < 2)
            return local.ToString("'Tomorrow at' h:mm tt");
        if (diff.TotalDays < 7)
            return local.ToString("dddd 'at' h:mm tt");

        return local.ToString("MMM d 'at' h:mm tt");
    }

    private async Task AddNewOrder()
    {
        await OpenOrderDialog(null);
    }

    private async Task EditOrder(ScheduledAllowance order)
    {
        await OpenOrderDialog(order.Id);
    }

    private async Task OpenOrderDialog(int? orderId)
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session == null) return;

        var parameters = new DialogParameters<OrderEditorDialog>
        {
            { x => x.ChildId, ChildId },
            { x => x.ParentUserId, session.UserId },
            { x => x.OrderId, orderId }
        };

        var dialog = await DialogService.ShowAsync<OrderEditorDialog>(
            null, parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadOrders();
        }
    }

    private async Task OpenResetDialog()
    {
        var parameters = new DialogParameters<ResetPicturePasswordDialog>
        {
            { x => x.ChildId, ChildId },
            { x => x.ChildName, _child!.Name }
        };

        var dialog = await DialogService.ShowAsync<ResetPicturePasswordDialog>(
            null, parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            _lockoutStatus = await UserService.GetChildLockoutStatusAsync(ChildId);
        }
    }

    private async Task UnlockChild()
    {
        await UserService.UnlockChildAsync(ChildId);
        _lockoutStatus = await UserService.GetChildLockoutStatusAsync(ChildId);
        Snackbar.Add($"{_child!.Name}'s account unlocked!", Severity.Success);
    }

    private async Task DeleteOrder(ScheduledAllowance order)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Order",
            $"Are you sure you want to delete \"{order.Description}\"?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            await AllowanceService.DeleteOrderAsync(order.Id);
            await LoadOrders();
            Snackbar.Add("Standing order deleted", Severity.Success);
        }
    }
}
