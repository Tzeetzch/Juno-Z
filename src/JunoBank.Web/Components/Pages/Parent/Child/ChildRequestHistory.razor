@page "/parent/child/{ChildId:int}/history"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Data.Entities
@using JunoBank.Web.Services
@using JunoBank.Web.Utils
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Request History - @(_child?.Name ?? "Child")</PageTitle>

<div style="max-width: 700px; margin: 0 auto; padding: 2rem;">
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else if (_child == null)
    {
        <MudAlert Severity="Severity.Error">Child not found</MudAlert>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   Class="mt-4"
                   OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.Dashboard))">
            Back to Dashboard
        </MudButton>
    }
    else
    {
        <ChildContextHeader ChildName="@_child.Name" BackUrl="@AppRoutes.Parent.ChildDetail(ChildId)" />

        <MudText Typo="Typo.h4" Style="margin-bottom: 2rem;">
            üìú Request History
        </MudText>

        @if (!_requests.Any())
        {
            <div class="neu-card" style="padding: 2rem; text-align: center;">
                <MudText Typo="Typo.h6">No completed requests yet</MudText>
                <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">
                    When you approve or deny @_child.Name's requests, they'll appear here.
                </MudText>
            </div>
        }
        else
        {
            @foreach (var request in _requests)
            {
                <div class="neu-card" style="padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <MudText Typo="Typo.body1" Style="font-weight: bold;">
                                    @(request.Type == RequestType.Withdrawal ? "üí∞ Withdrawal" : "üéÅ Deposit")
                                </MudText>
                                <MudChip T="string" 
                                         Size="Size.Small" 
                                         Color="@(request.Status == RequestStatus.Approved ? Color.Success : Color.Error)">
                                    @(request.Status == RequestStatus.Approved ? "Approved" : "Denied")
                                </MudChip>
                            </div>
                            <MudText Typo="Typo.body2">
                                @request.Description
                            </MudText>
                            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                Requested: @request.CreatedAt.ToString("dd MMM yyyy HH:mm")
                            </MudText>
                            @if (request.ResolvedAt.HasValue)
                            {
                                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                    @(request.Status == RequestStatus.Approved ? "Approved" : "Denied"): @request.ResolvedAt.Value.ToString("dd MMM yyyy HH:mm")
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(request.ParentNote))
                            {
                                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); font-style: italic;">
                                    Note: @request.ParentNote
                                </MudText>
                            }
                        </div>
                        <MudText Typo="Typo.h5" Style="@($"color: {(request.Status == RequestStatus.Approved ? "var(--mud-palette-success)" : "var(--mud-palette-error)")}; font-weight: bold;")">
                            ‚Ç¨@request.Amount.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
                        </MudText>
                    </div>
                </div>
            }
        }
    }
</div>

@code {
    [Parameter] public int ChildId { get; set; }

    private User? _child;
    private List<MoneyRequest> _requests = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session == null || session.Role != UserRole.Parent)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _child = await UserService.GetChildByIdAsync(ChildId);
        
        if (_child != null)
        {
            _requests = await UserService.GetCompletedRequestsForChildAsync(ChildId);
        }
        
        _isLoading = false;
    }
}
