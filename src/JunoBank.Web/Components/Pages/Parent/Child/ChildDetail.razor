@page "/parent/child/{ChildId:int}"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Services
@using JunoBank.Web.Utils
@using JunoBank.Web.Data.Entities
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>@(_child?.Name ?? "Child") - Juno Bank</PageTitle>

<div class="page-container-xl">
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else if (_child == null)
    {
        <MudAlert Severity="Severity.Error">Child not found</MudAlert>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   Class="mt-4"
                   OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.Dashboard))">
            Back to Dashboard
        </MudButton>
    }
    else
    {
        <ChildContextHeader ChildName="@_child.Name" BackUrl="@AppRoutes.Parent.Dashboard" />

        <!-- Balance Card -->
        <div class="neu-card" style="padding: 2rem; text-align: center; margin-bottom: 2rem;">
            <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 0.5rem;">
                @_child.Name's Balance
            </MudText>
            <MudText Typo="Typo.h2" Style="color: var(--mud-palette-primary); font-weight: bold;">
                â‚¬@_child.Balance.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
            </MudText>
        </div>

        <!-- Pending Requests -->
        @if (_openRequestCount > 0)
        {
            <div class="neu-card" style="padding: 2rem; text-align: center; margin-bottom: 2rem; cursor: pointer;"
                 @onclick="@(() => Navigation.NavigateTo(AppRoutes.Parent.ChildRequests(ChildId)))">
                <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 0.5rem;">
                    Pending Requests
                </MudText>
                <MudText Typo="Typo.h2" Style="color: #FFA726; font-weight: bold;">
                    @_openRequestCount
                </MudText>
                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); margin-top: 0.5rem;">
                    Tap to review
                </MudText>
            </div>
        }

        <!-- Actions for this child -->
        <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">Actions</MudText>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.ChildRequests(ChildId)))">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mr-1" /> Pending Requests @if (_openRequestCount > 0) { <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">@_openRequestCount</MudChip> }
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="OpenTransactionDialog">
                Add/Remove Money
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.ChildTransactionHistory(ChildId)))">
                <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="mr-1" /> Transaction History
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.ChildRequestHistory(ChildId)))">
                <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-1" /> Request History
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       Size="Size.Large"
                       Style="flex: 1; min-width: 200px;"
                       OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.ChildSettings(ChildId)))">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-1" /> Settings
            </MudButton>
        </div>
    }
</div>

@code {
    [Parameter] public int ChildId { get; set; }

    private User? _child;
    private int _openRequestCount;
    private int _parentUserId;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session != null)
            _parentUserId = session.UserId;

        _child = await UserService.GetChildByIdAsync(ChildId);
        if (_child != null)
        {
            _openRequestCount = await UserService.GetOpenRequestCountAsync(ChildId);
        }
        _isLoading = false;
    }

    private async Task OpenTransactionDialog()
    {
        if (_child == null) return;

        var parameters = new DialogParameters<ManualTransactionDialog>
        {
            { x => x.ChildId, ChildId },
            { x => x.ChildName, _child.Name },
            { x => x.ChildBalance, _child.Balance },
            { x => x.ParentUserId, _parentUserId }
        };

        var dialog = await DialogService.ShowAsync<ManualTransactionDialog>(
            null, parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            // Reload child data to reflect updated balance
            _child = await UserService.GetChildByIdAsync(ChildId);
            _openRequestCount = await UserService.GetOpenRequestCountAsync(ChildId);
        }
    }
}
