@page "/parent/child/{ChildId:int}/transactions"
@attribute [Authorize(Roles = "Parent")]
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Transactions - @(_child?.Name ?? "Child")</PageTitle>

<div class="page-container-lg">
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else if (_child == null)
    {
        <MudAlert Severity="Severity.Error">Child not found</MudAlert>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Class="mt-4"
                   OnClick="@(() => Navigation.NavigateTo(AppRoutes.Parent.Dashboard))">
            Back to Dashboard
        </MudButton>
    }
    else
    {
        <ChildContextHeader ChildName="@_child.Name" BackUrl="@AppRoutes.Parent.ChildDetail(ChildId)" />

        <MudText Typo="Typo.h4" HtmlTag="h1" Style="margin-bottom: 2rem;">
            <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="mr-2" /> @_child.Name's Transactions
        </MudText>

        @if (_transactions.Count == 0)
        {
            <div class="neu-card" style="padding: 2rem; text-align: center;">
                <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary);">
                    No transactions yet
                </MudText>
                <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">
                    Transactions will appear here once money is added or spent.
                </MudText>
            </div>
        }
        else
        {
            <TransactionList Transactions="_transactions" />

            @if (_hasMore)
            {
                <div style="text-align: center; margin-top: 1.5rem;">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               Disabled="_isLoadingMore"
                               OnClick="LoadMore">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Load More
                    </MudButton>
                </div>
            }
        }
    }
</div>

@code {
    [Parameter] public int ChildId { get; set; }

    private const int PageSize = 20;

    private User? _child;
    private List<Transaction> _transactions = new();
    private bool _isLoading = true;
    private bool _isLoadingMore;
    private bool _hasMore;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();
        if (session == null || session.Role != UserRole.Parent)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _child = await UserService.GetChildByIdAsync(ChildId);

        if (_child != null)
        {
            var batch = await UserService.GetTransactionsForChildAsync(ChildId, 0, PageSize);
            _transactions = batch;
            _hasMore = batch.Count == PageSize;
        }

        _isLoading = false;
    }

    private async Task LoadMore()
    {
        _isLoadingMore = true;

        var batch = await UserService.GetTransactionsForChildAsync(ChildId, _transactions.Count, PageSize);
        _transactions.AddRange(batch);
        _hasMore = batch.Count == PageSize;

        _isLoadingMore = false;
    }
}
