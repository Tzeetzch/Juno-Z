@page "/parent/settings"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Services
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject IEmailConfigService EmailConfigService
@inject INotificationService NotificationService
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Settings</PageTitle>

<div class="page-container">

    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => Navigation.NavigateTo("/parent"))">
        ← Back to Dashboard
    </MudButton>

    <MudText Typo="Typo.h4" HtmlTag="h1" Style="margin: 1rem 0 2rem;">
        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" /> Settings
    </MudText>

    <MudAlert Severity="Severity.Info" Class="mb-4">
        Settings are now managed per child. Select a child below to configure their allowance.
    </MudAlert>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else
    {
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            @foreach (var child in _children)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo($"/parent/child/{child.Id}/settings"))">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-1" /> @child.Name's Settings
                </MudButton>
            }
        </div>

        <!-- Notifications — all parents -->
        <MudDivider Class="my-6" />
        <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">
            <MudIcon Icon="@Icons.Material.Filled.Notifications" Class="mr-2" /> Notifications
        </MudText>

        <div class="neu-card" style="padding: 1.5rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    @if (_notificationEnabled)
                    {
                        <MudText Typo="Typo.body1">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" Class="mr-1" />
                            Weekly summary enabled
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @_notificationSchedule
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body1">
                            <MudIcon Icon="@Icons.Material.Filled.NotificationsOff" Color="Color.Default" Size="Size.Small" Class="mr-1" />
                            No notifications configured
                        </MudText>
                    }
                </div>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="OpenNotificationDialog">
                    Configure
                </MudButton>
            </div>
        </div>

        @if (_isAdmin)
        {
            <AdminPanel CurrentUserId="_currentUserId"
                        Parents="_parents"
                        Children="_children"
                        OnDataChanged="RefreshData" />

            <!-- Email Settings -->
            <MudDivider Class="my-6" />
            <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">
                <MudIcon Icon="@Icons.Material.Filled.Email" Class="mr-2" /> Email Settings
            </MudText>

            <div class="neu-card" style="padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        @if (EmailConfigService.IsConfigured)
                        {
                            <MudText Typo="Typo.body1">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" Class="mr-1" />
                                SMTP configured
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Password reset emails are enabled
                            </MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body1">
                                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" Class="mr-1" />
                                Not configured
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Password reset emails are disabled
                            </MudText>
                        }
                    </div>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               OnClick="OpenEmailDialog">
                        Configure
                    </MudButton>
                </div>
            </div>
        }
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isAdmin;
    private int _currentUserId;
    private bool _notificationEnabled;
    private string _notificationSchedule = "";

    private List<ChildSummary> _children = new();
    private List<ParentSummary> _parents = new();

    protected override async Task OnInitializedAsync()
    {
        var user = await AuthProvider.GetCurrentUserAsync();
        if (user != null)
        {
            _currentUserId = user.UserId;
            _isAdmin = await UserService.IsAdminAsync(user.UserId);
        }

        await RefreshData();
        _isLoading = false;
    }

    private async Task RefreshData()
    {
        _children = await UserService.GetAllChildrenSummaryAsync();
        await LoadNotificationPreference();

        if (_isAdmin)
        {
            _parents = await UserService.GetAllParentsAsync();
        }
    }

    private async Task LoadNotificationPreference()
    {
        var pref = await NotificationService.GetPreferenceAsync(
            _currentUserId, Data.Entities.NotificationType.WeeklySummary);

        if (pref is { Enabled: true })
        {
            _notificationEnabled = true;
            _notificationSchedule = $"Every {pref.DayOfWeek} at {pref.TimeOfDay:HH:mm}";
        }
        else
        {
            _notificationEnabled = false;
            _notificationSchedule = "";
        }
    }

    private async Task OpenNotificationDialog()
    {
        var parameters = new DialogParameters<NotificationSettingsDialog>
        {
            { x => x.UserId, _currentUserId }
        };

        var dialog = await DialogService.ShowAsync<NotificationSettingsDialog>(
            null, parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadNotificationPreference();
            StateHasChanged();
        }
    }

    private async Task OpenEmailDialog()
    {
        var adminUser = _parents.FirstOrDefault(p => p.Id == _currentUserId);
        var parameters = new DialogParameters<EmailSettingsDialog>
        {
            { x => x.AdminEmail, adminUser?.Email ?? "" }
        };

        var dialog = await DialogService.ShowAsync<EmailSettingsDialog>(
            null, parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        await dialog.Result;
        StateHasChanged();
    }
}
