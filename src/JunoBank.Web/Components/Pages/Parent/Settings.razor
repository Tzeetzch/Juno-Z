@page "/parent/settings"
@attribute [Authorize(Roles = "Parent")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Services
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Settings</PageTitle>

<div class="page-container">

    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => Navigation.NavigateTo("/parent"))">
        ‚Üê Back to Dashboard
    </MudButton>

    <MudText Typo="Typo.h4" HtmlTag="h1" Style="margin: 1rem 0 2rem;">
        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" /> Settings
    </MudText>

    <MudAlert Severity="Severity.Info" Class="mb-4">
        Settings are now managed per child. Select a child below to configure their allowance.
    </MudAlert>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else
    {
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            @foreach (var child in _children)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo($"/parent/child/{child.Id}/settings"))">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-1" /> @child.Name's Settings
                </MudButton>
            }
        </div>

        @if (_isAdmin)
        {
            <AdminPanel CurrentUserId="_currentUserId"
                        Parents="_parents"
                        Children="_children"
                        OnDataChanged="RefreshData" />
        }
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isAdmin;
    private int _currentUserId;

    private List<ChildSummary> _children = new();
    private List<ParentSummary> _parents = new();

    protected override async Task OnInitializedAsync()
    {
        var user = await AuthProvider.GetCurrentUserAsync();
        if (user != null)
        {
            _currentUserId = user.UserId;
            _isAdmin = await UserService.IsAdminAsync(user.UserId);
        }

        await RefreshData();
        _isLoading = false;
    }

    private async Task RefreshData()
    {
        _children = await UserService.GetAllChildrenSummaryAsync();

        if (_isAdmin)
        {
            _parents = await UserService.GetAllParentsAsync();
        }
    }
}
