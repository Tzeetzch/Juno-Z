@page "/login"
@using JunoBank.Web.Auth
@using JunoBank.Web.Data.Entities

<PageTitle>Login - Juno Bank</PageTitle>

<AuthorizeView>
    <Authorized>
        @* Authenticated users get redirected to home *@
    </Authorized>
    <NotAuthorized>
        <div style="max-width: 400px; margin: 2rem auto; text-align: center;">
            <MudText Typo="Typo.h4" Class="mb-6">Welcome to Juno Bank</MudText>

            <MudText Typo="Typo.body1" Class="mb-4">Who are you?</MudText>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <button class="neu-btn neu-btn-primary neu-btn-large" @onclick="GoToParentLogin">
                    I'm a Parent
                </button>

                <button class="neu-btn neu-btn-secondary neu-btn-large" @onclick="GoToChildLogin">
                    I'm a Kid
                </button>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private CustomAuthStateProvider AuthProvider { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var user = await AuthProvider.GetCurrentUserAsync();
            if (user != null)
            {
                // Redirect to appropriate dashboard based on role
                var redirectUrl = user.Role == JunoBank.Web.Data.Entities.UserRole.Child
                    ? "/child"
                    : "/parent";
                Navigation.NavigateTo(redirectUrl);
            }
        }
    }

    private void GoToParentLogin()
    {
        Navigation.NavigateTo("/login/parent");
    }

    private void GoToChildLogin()
    {
        Navigation.NavigateTo("/login/child");
    }
}
