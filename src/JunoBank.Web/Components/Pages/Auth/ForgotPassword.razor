@page "/forgot-password"

<PageTitle>Forgot Password - Juno Bank</PageTitle>

<div style="max-width: 400px; margin: 2rem auto;">
    <MudText Typo="Typo.h4" HtmlTag="h1" Class="mb-6" Align="Align.Center">Forgot Password</MudText>

    @if (_submitted)
    {
        <div class="neu-card">
            <MudAlert Severity="Severity.Success" Class="mb-4">
                If an account with that email exists, you will receive a password reset link shortly.
            </MudAlert>
            <MudText Typo="Typo.body2" Class="mb-4">
                The link will expire in 15 minutes. Check your spam folder if you don't see it.
            </MudText>
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       FullWidth="true"
                       OnClick="GoToLogin">
                ← Back to Login
            </MudButton>
        </div>
    }
    else
    {
        <div class="neu-card">
            <MudText Typo="Typo.body1" Class="mb-4">
                Enter your email address and we'll send you a link to reset your password.
            </MudText>

            <MudTextField @bind-Value="_email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          InputType="InputType.Email"
                          Class="mb-4"
                          FullWidth="true"
                          Disabled="_isLoading" />

            <ErrorAlert Message="@_error" />

            <button class="neu-btn neu-btn-primary neu-btn-large"
                    style="width: 100%;"
                    @onclick="HandleSubmit"
                    disabled="@_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <span>Send Reset Link</span>
                }
            </button>
        </div>

        <MudButton Variant="Variant.Text"
                   Color="Color.Secondary"
                   Class="mt-4"
                   FullWidth="true"
                   OnClick="GoToLogin">
            ← Back to Login
        </MudButton>
    }
</div>

@code {
    [Inject] private IPasswordResetService PasswordResetService { get; set; } = default!;
    [Inject] private IEmailService EmailService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private string _email = string.Empty;
    private string _error = string.Empty;
    private bool _isLoading;
    private bool _submitted;

    private async Task HandleSubmit()
    {
        _error = string.Empty;

        if (string.IsNullOrWhiteSpace(_email))
        {
            _error = "Please enter your email address.";
            return;
        }

        // Check if demo account - show same generic message
        if (PasswordResetService.IsDemoAccount(_email))
        {
            // Don't reveal that this is a demo account, show generic success
            _submitted = true;
            return;
        }

        _isLoading = true;

        try
        {
            var token = await PasswordResetService.CreateResetTokenAsync(_email);

            if (token != null)
            {
                // Send email with reset link
                var resetUrl = $"{Navigation.BaseUri}reset-password/{token}";
                var htmlBody = $@"
                    <h2>Password Reset Request</h2>
                    <p>You requested to reset your password for Juno Bank.</p>
                    <p>Click the link below to reset your password:</p>
                    <p><a href='{resetUrl}'>Reset Password</a></p>
                    <p>This link will expire in 15 minutes.</p>
                    <p>If you didn't request this, you can safely ignore this email.</p>
                ";

                await EmailService.SendEmailAsync(_email, "Juno Bank - Password Reset", htmlBody);
            }

            // Always show success to not reveal if email exists
            _submitted = true;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}
