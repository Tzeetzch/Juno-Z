@page "/reset-password/{Token}"
@using JunoBank.Web.Data
@using JunoBank.Web.Services
@using Microsoft.EntityFrameworkCore

<PageTitle>Reset Password - Juno Bank</PageTitle>

<div style="max-width: 400px; margin: 2rem auto;">
    <MudText Typo="Typo.h4" Class="mb-6" Align="Align.Center">Reset Password</MudText>

    @if (_completed)
    {
        <div class="neu-card">
            <MudAlert Severity="Severity.Success" Class="mb-4">
                Your password has been reset successfully!
            </MudAlert>
            <button class="neu-btn neu-btn-primary neu-btn-large"
                    style="width: 100%;"
                    @onclick="GoToLogin">
                Login Now
            </button>
        </div>
    }
    else if (!_tokenValid)
    {
        <div class="neu-card">
            <MudAlert Severity="Severity.Error" Class="mb-4">
                This password reset link is invalid or has expired.
            </MudAlert>
            <MudText Typo="Typo.body2" Class="mb-4">
                Please request a new password reset link.
            </MudText>
            <button class="neu-btn neu-btn-primary neu-btn-large"
                    style="width: 100%;"
                    @onclick="GoToForgotPassword">
                Request New Link
            </button>
        </div>
    }
    else
    {
        <div class="neu-card">
            <MudTextField @bind-Value="_newPassword"
                          Label="New Password"
                          Variant="Variant.Outlined"
                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                          Adornment="Adornment.End"
                          AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                          OnAdornmentClick="@(() => _showPassword = !_showPassword)"
                          Class="mb-4"
                          FullWidth="true"
                          Disabled="_isLoading" />

            <MudTextField @bind-Value="_confirmPassword"
                          Label="Confirm Password"
                          Variant="Variant.Outlined"
                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                          Class="mb-4"
                          FullWidth="true"
                          Disabled="_isLoading" />

            <MudText Typo="Typo.caption" Class="mb-4" Color="Color.Secondary">
                Password must be at least 8 characters long.
            </MudText>

            @if (!string.IsNullOrEmpty(_error))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
            }

            <button class="neu-btn neu-btn-primary neu-btn-large"
                    style="width: 100%;"
                    @onclick="HandleReset"
                    disabled="@_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <span>Reset Password</span>
                }
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public string Token { get; set; } = string.Empty;

    [Inject] private IPasswordService PasswordService { get; set; } = default!;
    [Inject] private IPasswordResetService PasswordResetService { get; set; } = default!;
    [Inject] private AppDbContext Db { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _error = string.Empty;
    private bool _isLoading;
    private bool _tokenValid;
    private bool _completed;
    private bool _showPassword;
    private int? _userId;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Token))
        {
            _userId = await PasswordResetService.ValidateTokenAsync(Token);
            _tokenValid = _userId.HasValue;
        }
    }

    private async Task HandleReset()
    {
        _error = string.Empty;

        if (string.IsNullOrWhiteSpace(_newPassword))
        {
            _error = "Please enter a new password.";
            return;
        }

        if (_newPassword.Length < 8)
        {
            _error = "Password must be at least 8 characters long.";
            return;
        }

        if (_newPassword != _confirmPassword)
        {
            _error = "Passwords do not match.";
            return;
        }

        _isLoading = true;

        try
        {
            // Hash the password
            var passwordHash = PasswordService.HashPassword(_newPassword);

            var result = await PasswordResetService.ResetPasswordAsync(Token, passwordHash);

            if (result)
            {
                _completed = true;
            }
            else
            {
                _error = "Unable to reset password. The link may have expired.";
                _tokenValid = false;
            }
        }
        catch (Exception)
        {
            _error = "An error occurred. Please try again.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void GoToForgotPassword()
    {
        Navigation.NavigateTo("/forgot-password");
    }
}
