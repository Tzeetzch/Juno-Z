@page "/login/parent"
@using JunoBank.Web.Services
@implements IDisposable

<PageTitle>Parent Login - Juno Bank</PageTitle>

<div style="max-width: 400px; margin: 2rem auto;">
    <MudText Typo="Typo.h4" Class="mb-6" Align="Align.Center">Parent Login</MudText>

    <form @onsubmit="HandleLogin" @onsubmit:preventDefault>
        <div class="neu-card">
            <MudTextField @bind-Value="_email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          InputType="InputType.Email"
                          Class="mb-4"
                          FullWidth="true" />

            <MudTextField @bind-Value="_password"
                          Label="Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Class="mb-4"
                          FullWidth="true" />

            @if (_isLockedOut && _lockoutUntil.HasValue)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    Account locked. Try again in @_countdownDisplay
                </MudAlert>
            }
            else if (_attemptsRemaining.HasValue)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    Wrong password. @_attemptsRemaining attempts remaining.
                </MudAlert>
            }
            else if (!string.IsNullOrEmpty(_error))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
            }

            <button type="submit"
                    class="neu-btn neu-btn-primary neu-btn-large"
                    style="width: 100%;"
                    disabled="@(_isLoading || _isLockedOut)">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <span>Login</span>
                }
            </button>

            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       Class="mt-2"
                       FullWidth="true"
                       OnClick="GoToForgotPassword">
                Forgot Password?
            </MudButton>
        </div>
    </form>

    <MudButton Variant="Variant.Text"
               Color="Color.Secondary"
               Class="mt-4"
               FullWidth="true"
               OnClick="GoBack">
        ‚Üê Back
    </MudButton>
</div>

@code {
    [Inject] private IAuthService AuthService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _error = string.Empty;
    private bool _isLoading;
    private bool _isLockedOut;
    private DateTime? _lockoutUntil;
    private int? _attemptsRemaining;
    private string _countdownDisplay = string.Empty;
    private System.Threading.Timer? _countdownTimer;

    private async Task HandleLogin()
    {
        _error = string.Empty;
        _attemptsRemaining = null;
        _isLockedOut = false;
        _isLoading = true;

        try
        {
            var result = await AuthService.AuthenticateParentAsync(_email, _password);

            if (!result.Success)
            {
                if (result.IsLockedOut && result.LockoutUntil.HasValue)
                {
                    _isLockedOut = true;
                    _lockoutUntil = result.LockoutUntil.Value;
                    StartCountdownTimer();
                }
                else if (result.AttemptsRemaining.HasValue)
                {
                    _attemptsRemaining = result.AttemptsRemaining.Value;
                }
                else
                {
                    _error = result.Error ?? "Invalid email or password";
                }
                return;
            }

            Navigation.NavigateTo("/parent");
        }
        catch (Exception ex)
        {
            _error = "An error occurred. Please try again.";
            Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void StartCountdownTimer()
    {
        _countdownTimer?.Dispose();
        UpdateCountdown();

        _countdownTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                UpdateCountdown();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void UpdateCountdown()
    {
        if (!_lockoutUntil.HasValue)
        {
            _countdownDisplay = string.Empty;
            return;
        }

        var remaining = _lockoutUntil.Value - DateTime.UtcNow;

        if (remaining.TotalSeconds <= 0)
        {
            _isLockedOut = false;
            _lockoutUntil = null;
            _countdownTimer?.Dispose();
            _countdownDisplay = string.Empty;
            return;
        }

        var minutes = (int)remaining.TotalMinutes;
        var seconds = remaining.Seconds;
        _countdownDisplay = $"{minutes}:{seconds:D2}";
    }

    public void Dispose()
    {
        _countdownTimer?.Dispose();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/login");
    }

    private void GoToForgotPassword()
    {
        Navigation.NavigateTo("/forgot-password");
    }
}
