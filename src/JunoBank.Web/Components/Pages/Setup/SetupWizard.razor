@page "/setup"
@using JunoBank.Web.Components.Layout
@using JunoBank.Web.Services
@using JunoBank.Web.Utils
@layout EmptyLayout

<PageTitle>Setup - Juno Bank</PageTitle>

<div class="setup-container">
    <div class="setup-card neu-card">
        @* Progress indicator *@
        @if (_currentStep <= 5)
        {
            <div class="setup-progress">
                <div class="progress-steps">
                    @for (int i = 1; i <= 5; i++)
                    {
                        var step = i;
                        <div class="progress-step @(step < _currentStep ? "completed" : step == _currentStep ? "active" : "")">
                            <div class="step-number">@step</div>
                        </div>
                        @if (i < 5)
                        {
                            <div class="step-line @(step < _currentStep ? "completed" : "")"></div>
                        }
                    }
                </div>
                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); text-align: center; margin-top: 0.5rem;">
                    @GetStepName(_currentStep)
                </MudText>
            </div>
        }

        @switch (_currentStep)
        {
            case 1:
                <SetupStep1 Model="_adminData" OnNext="GoToStep2" />
                break;
            case 2:
                <SetupStep2 Model="_partnerData" OnNext="GoToStep3" OnBack="GoToStep1" OnSkip="SkipPartner" />
                break;
            case 3:
                <SetupStep3 Children="_children" OnNext="GoToStep4" OnBack="GoToStep2" />
                break;
            case 4:
                <SetupStep4Email Model="_emailData" AdminEmail="@_adminData.Email"
                                 OnNext="GoToStep5" OnBack="GoToStep3" OnSkip="SkipEmail" />
                break;
            case 5:
                <SetupStep4 Admin="_adminData" Partner="_partnerData" Children="_children"
                            OnBack="GoToStep4" OnEdit="HandleEdit" OnSubmit="HandleSubmit"
                            IsSubmitting="_isSubmitting" />
                break;
            case 6:
                <SetupComplete ChildNames="@_children.Select(c => c.Name).ToList()" />
                break;
        }
    </div>
</div>

<style>
    .setup-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: var(--bg-color, #1a1a2e);
    }

    .setup-card {
        width: 100%;
        max-width: 500px;
        padding: 2rem;
    }

    .setup-progress {
        margin-bottom: 2rem;
    }

    .progress-steps {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
    }

    .progress-step {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .step-number {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        background: var(--bg-color);
        color: var(--text-secondary, rgba(255,255,255,0.5));
        box-shadow:
            inset 2px 2px 4px var(--shadow-dark, #0d0d17),
            inset -2px -2px 4px var(--shadow-light, #272745);
        transition: all 0.3s ease;
    }

    .progress-step.active .step-number {
        background: linear-gradient(145deg, #ff8555, #ff6b35);
        color: white;
        box-shadow:
            3px 3px 6px var(--shadow-dark, #0d0d17),
            -3px -3px 6px var(--shadow-light, #272745);
    }

    .progress-step.completed .step-number {
        background: var(--primary, #FF6B35);
        color: white;
        box-shadow:
            2px 2px 4px var(--shadow-dark, #0d0d17),
            -2px -2px 4px var(--shadow-light, #272745);
    }

    .step-line {
        width: 40px;
        height: 3px;
        background: var(--bg-color);
        box-shadow:
            inset 1px 1px 2px var(--shadow-dark, #0d0d17),
            inset -1px -1px 2px var(--shadow-light, #272745);
        transition: all 0.3s ease;
    }

    .step-line.completed {
        background: var(--primary, #FF6B35);
        box-shadow: 0 0 8px var(--primary, #FF6B35);
    }

    @@media (min-width: 768px) {
        .setup-card {
            max-width: 550px;
            padding: 2.5rem;
        }

        .step-number {
            width: 44px;
            height: 44px;
            font-size: 1rem;
        }

        .step-line {
            width: 60px;
        }
    }

    @@media (min-width: 1200px) {
        .setup-card {
            max-width: 600px;
        }
    }
</style>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private ISetupService SetupService { get; set; } = default!;
    [Inject] private IAuthService AuthService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private int _currentStep = 1;
    private bool _isSubmitting;

    // Wizard state
    private AdminFormModel _adminData = new();
    private PartnerFormModel? _partnerData;
    private List<ChildFormModel> _children = new();
    private SetupStep4Email.EmailFormModel _emailData = new();

    protected override async Task OnInitializedAsync()
    {
        // Redirect away if setup not needed
        if (!await SetupService.IsSetupRequiredAsync())
        {
            Navigation.NavigateTo("/");
        }
    }

    private void GoToStep1() => _currentStep = 1;
    private void GoToStep2() => _currentStep = 2;
    private void GoToStep3() => _currentStep = 3;
    private void GoToStep4() => _currentStep = 4;
    private void GoToStep5() => _currentStep = 5;

    private void SkipPartner()
    {
        _partnerData = null;
        GoToStep3();
    }

    private void SkipEmail()
    {
        _emailData = new SetupStep4Email.EmailFormModel();
        GoToStep5();
    }

    private void HandleEdit(int step)
    {
        _currentStep = step;
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        StateHasChanged();

        var emailConfig = !string.IsNullOrWhiteSpace(_emailData.Username)
            ? new EmailConfigData
            {
                Host = _emailData.Host,
                Port = _emailData.Port,
                Username = _emailData.Username!,
                Password = _emailData.Password!,
                FromEmail = string.IsNullOrWhiteSpace(_emailData.FromEmail) ? _emailData.Username! : _emailData.FromEmail
            }
            : null;

        var data = new SetupData
        {
            Admin = new AdminData
            {
                Name = _adminData.Name,
                Email = _adminData.Email,
                Password = _adminData.Password
            },
            Partner = _partnerData != null ? new PartnerData
            {
                Name = _partnerData.Name,
                Email = _partnerData.Email,
                Password = _partnerData.Password
            } : null,
            Children = _children.Select(c => new ChildData
            {
                Name = c.Name,
                Birthday = c.Birthday,
                StartingBalance = c.StartingBalance,
                PictureSequence = c.PictureSequence.ToArray()
            }).ToList(),
            Email = emailConfig
        };

        var result = await SetupService.CompleteSetupAsync(data);

        if (result.Success)
        {
            // Auto-login as admin
            var authResult = await AuthService.AuthenticateParentAsync(_adminData.Email, _adminData.Password);
            if (authResult.Success)
            {
                _currentStep = 6; // Success screen
            }
            else
            {
                Snackbar.Add("Setup complete! Please log in.", Severity.Success);
                Navigation.NavigateTo(AppRoutes.Auth.Login);
            }
        }
        else
        {
            Snackbar.Add(result.Error ?? "Setup failed", Severity.Error);
        }

        _isSubmitting = false;
    }

    private string GetStepName(int step) => step switch
    {
        1 => "Your Account",
        2 => "Partner",
        3 => "Children",
        4 => "Email",
        5 => "Review",
        _ => ""
    };

    // Form models for wizard state
    public class AdminFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class PartnerFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class ChildFormModel
    {
        public string Name { get; set; } = string.Empty;
        public DateTime Birthday { get; set; } = DateTime.Today.AddYears(-5);
        public decimal StartingBalance { get; set; }
        public List<string> PictureSequence { get; set; } = new();
    }
}
