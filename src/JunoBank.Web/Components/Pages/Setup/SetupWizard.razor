@page "/setup"
@using JunoBank.Web.Components.Layout
@using JunoBank.Web.Services
@using JunoBank.Web.Utils
@layout EmptyLayout

<PageTitle>Setup - Juno Bank</PageTitle>

<div class="setup-container">
    <div class="setup-card neu-card">
        @* Progress indicator *@
        <div class="setup-progress">
            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                Step @_currentStep of 4
            </MudText>
            <MudProgressLinear Value="@(_currentStep * 25)" Color="Color.Primary" Rounded="true" Size="Size.Small" />
        </div>

        @switch (_currentStep)
        {
            case 1:
                <SetupStep1 Model="_adminData" OnNext="GoToStep2" />
                break;
            case 2:
                <SetupStep2 Model="_partnerData" OnNext="GoToStep3" OnBack="GoToStep1" OnSkip="SkipPartner" />
                break;
            case 3:
                <SetupStep3 Children="_children" OnNext="GoToStep4" OnBack="GoToStep2" />
                break;
            case 4:
                <SetupStep4 Admin="_adminData" Partner="_partnerData" Children="_children" 
                            OnBack="GoToStep3" OnEdit="HandleEdit" OnSubmit="HandleSubmit"
                            IsSubmitting="_isSubmitting" />
                break;
            case 5:
                <SetupComplete ChildNames="@_children.Select(c => c.Name).ToList()" />
                break;
        }
    </div>
</div>

<style>
    .setup-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: var(--bg-color, #1a1a2e);
    }

    .setup-card {
        width: 100%;
        max-width: 600px;
        padding: 2rem;
    }

    .setup-progress {
        margin-bottom: 2rem;
    }

    @@media (min-width: 1200px) {
        .setup-card {
            max-width: 700px;
        }
    }
</style>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private ISetupService SetupService { get; set; } = default!;
    [Inject] private IAuthService AuthService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private int _currentStep = 1;
    private bool _isSubmitting;

    // Wizard state
    private AdminFormModel _adminData = new();
    private PartnerFormModel? _partnerData;
    private List<ChildFormModel> _children = new();

    protected override async Task OnInitializedAsync()
    {
        // Redirect away if setup not needed
        if (!await SetupService.IsSetupRequiredAsync())
        {
            Navigation.NavigateTo("/");
        }
    }

    private void GoToStep1() => _currentStep = 1;
    private void GoToStep2() => _currentStep = 2;
    private void GoToStep3() => _currentStep = 3;
    private void GoToStep4() => _currentStep = 4;

    private void SkipPartner()
    {
        _partnerData = null;
        GoToStep3();
    }

    private void HandleEdit(int step)
    {
        _currentStep = step;
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        StateHasChanged();

        var data = new SetupData
        {
            Admin = new AdminData
            {
                Name = _adminData.Name,
                Email = _adminData.Email,
                Password = _adminData.Password
            },
            Partner = _partnerData != null ? new PartnerData
            {
                Name = _partnerData.Name,
                Email = _partnerData.Email,
                Password = _partnerData.Password
            } : null,
            Children = _children.Select(c => new ChildData
            {
                Name = c.Name,
                Birthday = c.Birthday,
                StartingBalance = c.StartingBalance,
                PictureSequence = c.PictureSequence.ToArray()
            }).ToList()
        };

        var result = await SetupService.CompleteSetupAsync(data);

        if (result.Success)
        {
            // Auto-login as admin
            var authResult = await AuthService.AuthenticateParentAsync(_adminData.Email, _adminData.Password);
            if (authResult.Success)
            {
                _currentStep = 5; // Success screen
            }
            else
            {
                Snackbar.Add("Setup complete! Please log in.", Severity.Success);
                Navigation.NavigateTo(AppRoutes.Auth.Login);
            }
        }
        else
        {
            Snackbar.Add(result.Error ?? "Setup failed", Severity.Error);
        }

        _isSubmitting = false;
    }

    // Form models for wizard state
    public class AdminFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class PartnerFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class ChildFormModel
    {
        public string Name { get; set; } = string.Empty;
        public DateTime Birthday { get; set; } = DateTime.Today.AddYears(-5);
        public decimal StartingBalance { get; set; }
        public List<string> PictureSequence { get; set; } = new();
    }
}
