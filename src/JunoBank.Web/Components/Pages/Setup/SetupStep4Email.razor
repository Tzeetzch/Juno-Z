@using JunoBank.Web.Services

<div style="text-align: center; margin-bottom: 1.5rem;">
    <MudText Typo="Typo.h4" Class="mb-2" Style="color: var(--primary);">Email Setup</MudText>
    <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-secondary);">
        Optional — configure email so you can reset your password if you forget it
    </MudText>
</div>

<MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
    You can use a Gmail account to send reset emails. Skip this if you prefer to set it up later.
</MudAlert>

<MudExpansionPanels Class="mb-4">
    <MudExpansionPanel Text="Gmail Setup Instructions">
        <MudText Typo="Typo.body2" Class="mb-2">
            <ol style="padding-left: 1.2rem; margin: 0;">
                <li style="margin-bottom: 0.5rem;">Go to <strong>Google Account</strong> → <strong>Security</strong> → enable <strong>2-Step Verification</strong></li>
                <li style="margin-bottom: 0.5rem;">Search for <strong>"App Passwords"</strong> and create one for <strong>"Mail"</strong></li>
                <li>Copy the <strong>16-character password</strong> (spaces are okay to include)</li>
            </ol>
        </MudText>
    </MudExpansionPanel>
</MudExpansionPanels>

<MudForm @ref="_form">
    <MudTextField @bind-Value="Model.Host"
                  Label="SMTP Host"
                  Placeholder="smtp.gmail.com"
                  Class="mb-3" />
    <MudNumericField @bind-Value="Model.Port"
                     Label="Port"
                     Min="1" Max="65535"
                     Class="mb-3" />
    <MudTextField @bind-Value="Model.Username"
                  Label="Email / Username"
                  Placeholder="you@gmail.com"
                  InputType="InputType.Email"
                  Class="mb-3" />
    <MudTextField @bind-Value="Model.Password"
                  Label="App Password"
                  Placeholder="xxxx xxxx xxxx xxxx"
                  InputType="InputType.Password"
                  Class="mb-3" />
    <MudTextField @bind-Value="Model.FromEmail"
                  Label="From Email (usually same as username)"
                  Placeholder="you@gmail.com"
                  InputType="InputType.Email"
                  Class="mb-3" />
</MudForm>

@if (!string.IsNullOrEmpty(_testResult))
{
    <MudAlert Severity="@_testSeverity" Class="mb-3" Dense="true">@_testResult</MudAlert>
}

<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
    <MudButton Variant="Variant.Outlined"
               Color="Color.Primary"
               OnClick="SendTestEmail"
               Disabled="@(_isTesting || !HasRequiredFields)"
               Size="Size.Small">
        @if (_isTesting)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
        }
        Test Email
    </MudButton>
</div>

<div style="display: flex; justify-content: space-between;">
    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="HandleBack">
        ← Back
    </MudButton>
    <div style="display: flex; gap: 0.5rem;">
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="HandleSkip">
            Skip for now →
        </MudButton>
        <button type="button" class="neu-btn neu-btn-primary" @onclick="HandleNext" disabled="@(!HasRequiredFields)">
            Next →
        </button>
    </div>
</div>

@code {
    [Parameter, EditorRequired] public EmailFormModel Model { get; set; } = default!;
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnSkip { get; set; }
    [Parameter] public string AdminEmail { get; set; } = "";

    [Inject] private IServiceProvider ServiceProvider { get; set; } = default!;

    private MudForm? _form;
    private bool _isTesting;
    private string _testResult = "";
    private Severity _testSeverity = Severity.Info;

    private bool HasRequiredFields =>
        !string.IsNullOrWhiteSpace(Model.Host) &&
        Model.Port > 0 &&
        !string.IsNullOrWhiteSpace(Model.Username) &&
        !string.IsNullOrWhiteSpace(Model.Password);

    private async Task SendTestEmail()
    {
        _isTesting = true;
        _testResult = "";
        StateHasChanged();

        try
        {
            // Build a temporary config and SmtpEmailService to send a test
            var configData = new Dictionary<string, string?>
            {
                ["Email:Host"] = Model.Host,
                ["Email:Port"] = Model.Port.ToString(),
                ["Email:Username"] = Model.Username,
                ["Email:Password"] = Model.Password,
                ["Email:FromEmail"] = string.IsNullOrWhiteSpace(Model.FromEmail) ? Model.Username : Model.FromEmail,
                ["Email:UseSsl"] = "true"
            };

            var config = new ConfigurationBuilder()
                .AddInMemoryCollection(configData)
                .Build();

            var loggerFactory = ServiceProvider.GetRequiredService<ILoggerFactory>();
            var logger = loggerFactory.CreateLogger<SmtpEmailService>();
            var smtp = new SmtpEmailService(config, logger);

            var targetEmail = !string.IsNullOrWhiteSpace(AdminEmail) ? AdminEmail : Model.Username!;
            var success = await smtp.SendEmailAsync(
                targetEmail,
                "Juno Bank - Test Email",
                "<h2>It works!</h2><p>Your Juno Bank email is configured correctly. Password reset emails will be sent to this address.</p>");

            if (success)
            {
                _testResult = $"Test email sent to {targetEmail} — check your inbox!";
                _testSeverity = Severity.Success;
            }
            else
            {
                _testResult = "Failed to send test email. Check your settings.";
                _testSeverity = Severity.Error;
            }
        }
        catch (Exception ex)
        {
            _testResult = $"Error: {ex.Message}";
            _testSeverity = Severity.Error;
        }
        finally
        {
            _isTesting = false;
        }
    }

    private async Task HandleNext() => await OnNext.InvokeAsync();
    private async Task HandleBack() => await OnBack.InvokeAsync();
    private async Task HandleSkip() => await OnSkip.InvokeAsync();

    public class EmailFormModel
    {
        public string Host { get; set; } = "smtp.gmail.com";
        public int Port { get; set; } = 587;
        public string? Username { get; set; }
        public string? Password { get; set; }
        public string? FromEmail { get; set; }
    }
}
