@page "/child/request-deposit"
@attribute [Authorize(Roles = "Child")]
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Request Deposit</PageTitle>

<div class="page-container-sm">

    <MudText Typo="Typo.h4" HtmlTag="h1" Style="margin-bottom: 2rem; text-align: center;">
        üéÅ Add Money
    </MudText>

    @if (_isAtLimit)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <MudText Typo="Typo.h6">Too Many Requests! üõë</MudText>
            <MudText Typo="Typo.body2">
                You already have @_openRequestCount requests waiting. Please wait for Mom or Dad to review them first!
            </MudText>
        </MudAlert>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   OnClick="GoBackToDashboard">
            Back to My Piggy Bank
        </MudButton>
    }
    else
    {
        <ErrorAlert Message="@_errorMessage" OnClose="@(() => _errorMessage = string.Empty)" />
    }

    @if (_submitted)
    {
        <MudAlert Severity="Severity.Success" Class="mb-4">
            <MudText Typo="Typo.h6">Request Sent! ‚úÖ</MudText>
            <MudText Typo="Typo.body2">
                Mom or Dad will review your request soon!
            </MudText>
        </MudAlert>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   OnClick="GoBackToDashboard">
            Back to My Piggy Bank
        </MudButton>
    }
    else
    {
        <div class="neu-card" style="padding: 2rem;">
            <EditForm Model="_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudText Typo="Typo.body1" Class="mb-4">
                    How much money did you get? ü§î
                </MudText>

                <MoneyInput @bind-Value="_model.Amount"
                            Required="true"
                            HelperText="How much? (Max ‚Ç¨1000)" />

                <DescriptionField @bind-Value="_model.Reason"
                                  Label="Where did it come from?"
                                  Lines="3"
                                  HelperText="Tell Mom or Dad where the money came from"
                                  Placeholder="From grandma, birthday, etc." />

                <SubmitButton Text="Ask Mom or Dad"
                              LoadingText="Sending..."
                              IsLoading="_isSubmitting"
                              Class="mt-6" />

                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           FullWidth="true"
                           Class="mt-2"
                           OnClick="GoBackToDashboard"
                           Disabled="_isSubmitting">
                    Cancel
                </MudButton>
            </EditForm>
        </div>
    }
</div>

@code {
    private DepositRequestModel _model = new();
    private bool _isSubmitting = false;
    private bool _submitted = false;
    private string _errorMessage = string.Empty;
    private int _userId;
    private int _openRequestCount;
    private bool _isAtLimit = false;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();

        if (session == null || session.Role != UserRole.Child)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _userId = session.UserId;
        _openRequestCount = await UserService.GetOpenRequestCountAsync(_userId);
        _isAtLimit = _openRequestCount >= 5;
    }

    private async Task HandleSubmit()
    {
        if (_userId == 0)
        {
            _errorMessage = "Invalid user session. Please log in again.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = string.Empty;

        try
        {
            await UserService.CreateMoneyRequestAsync(
                _userId,
                _model.Amount,
                RequestType.Deposit,
                _model.Reason
            );

            _submitted = true;
            Snackbar.Add("Request sent! Mom or Dad will check it soon.", Severity.Success);
        }
        catch (ArgumentException ex)
        {
            _errorMessage = ex.Message;
        }
        catch (InvalidOperationException ex)
        {
            _errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            _errorMessage = "Oops! Something went wrong. Please try again.";
            Console.WriteLine($"Error creating request: {ex.Message}");
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void GoBackToDashboard()
    {
        Navigation.NavigateTo("/child");
    }

    public class DepositRequestModel
    {
        public decimal Amount { get; set; } = 0.00m;
        public string Reason { get; set; } = string.Empty;
    }
}
