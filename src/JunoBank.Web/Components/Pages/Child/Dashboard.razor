@page "/child"
@attribute [Authorize(Roles = "Child")]
@using JunoBank.Web.Auth
@using JunoBank.Web.Data.Entities
@using JunoBank.Web.Services
@using JunoBank.Web.Components.Shared
@using JunoBank.Web.Utils
@inject IAuthStateProvider AuthProvider
@inject IUserService UserService
@inject NavigationManager Navigation
@inject IBrowserTimeService BrowserTime

<PageTitle>My Piggy Bank</PageTitle>

<div class="page-container">

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else
    {
        <!-- Welcome Message -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <MudText Typo="Typo.h3" HtmlTag="h1" Style="color: var(--mud-palette-primary);">
                Hi @_userName! üëã
            </MudText>
        </div>

        <!-- Balance Card -->
        <div class="neu-card" style="padding: 3rem; text-align: center; margin-bottom: 2rem;">
            <MudText Typo="Typo.h6" Style="color: var(--mud-palette-text-secondary); margin-bottom: 1rem;">
                My Money
            </MudText>

            <MudText Typo="Typo.h1" Style="color: var(--mud-palette-primary); font-weight: bold;">
                ‚Ç¨@_balance.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
            </MudText>

            <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-secondary); margin-top: 1rem;">
                üê∑ Piggy Bank Balance
            </MudText>
        </div>

        <!-- Action Buttons -->
        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="@(() => Navigation.NavigateTo("/child/request-withdrawal"))">
                üí∞ Request Money
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="@(() => Navigation.NavigateTo("/child/request-deposit"))">
                üéÅ Add Money
            </MudButton>
        </div>

        <!-- My Requests -->
        @if (_requests.Any())
        {
            <div style="margin-top: 3rem;">
                <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">
                    üìã My Requests
                </MudText>

                @foreach (var request in _requests)
                {
                    <div class="neu-card" style="padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <MudText Typo="Typo.body1">
                                @(request.Type == RequestType.Withdrawal ? "üí∞" : "üéÅ") @request.Description
                            </MudText>
                            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                @BrowserTime.ToLocal(request.CreatedAt).ToString("dd MMM yyyy")
                            </MudText>
                        </div>
                        <div style="text-align: right;">
                            <MudText Typo="Typo.body1" Style="font-weight: bold;">
                                ‚Ç¨@request.Amount.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
                            </MudText>
                            <MudText Typo="Typo.caption" Style="@($"color: {GetStatusColor(request.Status)};")">
                                @GetStatusText(request.Status)
                            </MudText>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Transaction History -->
        <div style="margin-top: 3rem;">
            <MudText Typo="Typo.h5" HtmlTag="h2" Style="margin-bottom: 1rem;">
                üìú My Money History
            </MudText>
            <TransactionList Transactions="_transactions" />
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private string _userName = string.Empty;
    private decimal _balance = 0;
    private List<Transaction> _transactions = new();
    private List<MoneyRequest> _requests = new();

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthProvider.GetCurrentUserAsync();

        if (session != null)
        {
            var dashboardData = await UserService.GetChildDashboardDataAsync(session.UserId);
            _userName = dashboardData.Name;
            _balance = dashboardData.Balance;
            _transactions = dashboardData.RecentTransactions;
            _requests = dashboardData.RecentRequests;
        }

        _isLoading = false;
    }

    private static string GetStatusText(RequestStatus status) => StatusDisplayHelper.GetStatusText(status);

    private static string GetStatusColor(RequestStatus status) => StatusDisplayHelper.GetStatusColor(status);
}
