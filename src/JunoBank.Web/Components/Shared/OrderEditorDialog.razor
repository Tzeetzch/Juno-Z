
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @if (_isNew)
            {
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-1" /> <text>New Standing Order</text>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-1" /> <text>Edit Standing Order</text>
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        <ErrorAlert Message="@_errorMessage" />

        <MudSwitch @bind-Value="_isActive" Color="Color.Primary" Label="Active" Class="mb-4" />

        <MoneyInput @bind-Value="_amount"
                    HelperText="How much per payment? (Max â‚¬1000)" />

        <MudTextField @bind-Value="_description"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Class="mt-4"
                      Placeholder="e.g., Weekly Allowance"
                      HelperText="Shows in transaction history" />

        <MudSelect @bind-Value="_interval" @bind-Value:after="UpdateNextRunPreview"
                   Label="How often?"
                   Variant="Variant.Outlined"
                   Class="mt-4">
            <MudSelectItem Value="AllowanceInterval.Hourly">Every Hour (testing)</MudSelectItem>
            <MudSelectItem Value="AllowanceInterval.Daily">Daily</MudSelectItem>
            <MudSelectItem Value="AllowanceInterval.Weekly">Weekly</MudSelectItem>
            <MudSelectItem Value="AllowanceInterval.Monthly">Monthly</MudSelectItem>
            <MudSelectItem Value="AllowanceInterval.Yearly">Yearly</MudSelectItem>
        </MudSelect>

        @if (_interval == AllowanceInterval.Weekly)
        {
            <MudSelect @bind-Value="_dayOfWeek" @bind-Value:after="UpdateNextRunPreview"
                       Label="Day of week"
                       Variant="Variant.Outlined"
                       Class="mt-4">
                <MudSelectItem Value="DayOfWeek.Monday">Monday</MudSelectItem>
                <MudSelectItem Value="DayOfWeek.Tuesday">Tuesday</MudSelectItem>
                <MudSelectItem Value="DayOfWeek.Wednesday">Wednesday</MudSelectItem>
                <MudSelectItem Value="DayOfWeek.Thursday">Thursday</MudSelectItem>
                <MudSelectItem Value="DayOfWeek.Friday">Friday</MudSelectItem>
                <MudSelectItem Value="DayOfWeek.Saturday">Saturday</MudSelectItem>
                <MudSelectItem Value="DayOfWeek.Sunday">Sunday</MudSelectItem>
            </MudSelect>
        }

        @if (_interval == AllowanceInterval.Monthly || _interval == AllowanceInterval.Yearly)
        {
            <MudNumericField @bind-Value="_dayOfMonth" @bind-Value:after="UpdateNextRunPreview"
                             Label="Day of month"
                             Variant="Variant.Outlined"
                             Class="mt-4"
                             Min="1"
                             Max="28"
                             HelperText="1-28 (to work for all months)" />
        }

        @if (_interval == AllowanceInterval.Yearly)
        {
            <MudSelect @bind-Value="_monthOfYear" @bind-Value:after="UpdateNextRunPreview"
                       Label="Month"
                       Variant="Variant.Outlined"
                       Class="mt-4">
                <MudSelectItem Value="1">January</MudSelectItem>
                <MudSelectItem Value="2">February</MudSelectItem>
                <MudSelectItem Value="3">March</MudSelectItem>
                <MudSelectItem Value="4">April</MudSelectItem>
                <MudSelectItem Value="5">May</MudSelectItem>
                <MudSelectItem Value="6">June</MudSelectItem>
                <MudSelectItem Value="7">July</MudSelectItem>
                <MudSelectItem Value="8">August</MudSelectItem>
                <MudSelectItem Value="9">September</MudSelectItem>
                <MudSelectItem Value="10">October</MudSelectItem>
                <MudSelectItem Value="11">November</MudSelectItem>
                <MudSelectItem Value="12">December</MudSelectItem>
            </MudSelect>
        }

        @if (_interval != AllowanceInterval.Hourly)
        {
            <MudTimePicker @bind-Time="_timeOfDay" @bind-Time:after="UpdateNextRunPreview"
                           Label="Time of day"
                           Variant="Variant.Outlined"
                           Class="mt-4"
                           Editable="true" />
        }

        @if (_isActive && _nextRunPreview.HasValue)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4" Dense="true">
                <strong>Next payment:</strong> @FormatNextRun(_nextRunPreview.Value)
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="Save"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public int ChildId { get; set; }
    [Parameter] public int ParentUserId { get; set; }
    [Parameter] public int? OrderId { get; set; }

    [Inject] private IAllowanceService AllowanceService { get; set; } = default!;
    [Inject] private IBrowserTimeService BrowserTime { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private ScheduledAllowance? _existingOrder;
    private bool _isNew => OrderId == null || OrderId == 0;
    private bool _isSaving;
    private string _errorMessage = string.Empty;

    // Form fields
    private bool _isActive = true;
    private decimal _amount = 5.00m;
    private string _description = "Allowance";
    private AllowanceInterval _interval = AllowanceInterval.Weekly;
    private DayOfWeek _dayOfWeek = DayOfWeek.Saturday;
    private int _dayOfMonth = 1;
    private int _monthOfYear = 1;
    private TimeSpan? _timeOfDay = new TimeSpan(9, 0, 0);
    private DateTime? _nextRunPreview;

    protected override async Task OnInitializedAsync()
    {
        if (!_isNew)
        {
            _existingOrder = await AllowanceService.GetOrderByIdAsync(OrderId!.Value);
            if (_existingOrder != null)
            {
                _isActive = _existingOrder.IsActive;
                _amount = _existingOrder.Amount;
                _description = _existingOrder.Description;
                _interval = _existingOrder.Interval;
                _dayOfWeek = _existingOrder.DayOfWeek;
                _dayOfMonth = _existingOrder.DayOfMonth;
                _monthOfYear = _existingOrder.MonthOfYear;
                _timeOfDay = _existingOrder.TimeOfDay.ToTimeSpan();
            }
        }

        UpdateNextRunPreview();
    }

    private void UpdateNextRunPreview()
    {
        if (_isActive)
        {
            var localNow = BrowserTime.ToLocal(DateTime.UtcNow);
            _nextRunPreview = AllowanceService.CalculateNextRunDate(
                _interval,
                _dayOfWeek,
                _dayOfMonth,
                _monthOfYear,
                TimeOnly.FromTimeSpan(_timeOfDay ?? new TimeSpan(9, 0, 0)),
                localNow);
        }
        else
        {
            _nextRunPreview = null;
        }
    }

    private string FormatNextRun(DateTime next)
    {
        return _interval switch
        {
            AllowanceInterval.Hourly => next.ToString("MMM d 'at' h:mm tt"),
            AllowanceInterval.Daily => next.ToString("MMM d 'at' h:mm tt"),
            AllowanceInterval.Weekly => next.ToString("dddd, MMM d 'at' h:mm tt"),
            AllowanceInterval.Monthly => next.ToString("MMM d, yyyy 'at' h:mm tt"),
            AllowanceInterval.Yearly => next.ToString("MMMM d, yyyy 'at' h:mm tt"),
            _ => next.ToString("f")
        };
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Save()
    {
        _isSaving = true;
        _errorMessage = string.Empty;

        try
        {
            var tzId = BrowserTime.TimeZoneId ?? "UTC";

            if (_isNew)
            {
                var order = new ScheduledAllowance
                {
                    ChildId = ChildId,
                    CreatedByUserId = ParentUserId,
                    IsActive = _isActive,
                    Amount = _amount,
                    Description = _description,
                    Interval = _interval,
                    DayOfWeek = _dayOfWeek,
                    DayOfMonth = _dayOfMonth,
                    MonthOfYear = _monthOfYear,
                    TimeOfDay = TimeOnly.FromTimeSpan(_timeOfDay ?? new TimeSpan(9, 0, 0)),
                    TimeZoneId = tzId
                };
                await AllowanceService.CreateOrderAsync(order);
                Snackbar.Add("Standing order created!", Severity.Success);
            }
            else
            {
                _existingOrder!.IsActive = _isActive;
                _existingOrder.Amount = _amount;
                _existingOrder.Description = _description;
                _existingOrder.Interval = _interval;
                _existingOrder.DayOfWeek = _dayOfWeek;
                _existingOrder.DayOfMonth = _dayOfMonth;
                _existingOrder.MonthOfYear = _monthOfYear;
                _existingOrder.TimeOfDay = TimeOnly.FromTimeSpan(_timeOfDay ?? new TimeSpan(9, 0, 0));
                _existingOrder.TimeZoneId = tzId;
                await AllowanceService.UpdateOrderAsync(_existingOrder);
                Snackbar.Add("Standing order updated!", Severity.Success);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception)
        {
            _errorMessage = "Something went wrong. Please try again.";
        }
        finally
        {
            _isSaving = false;
        }
    }
}
